{"componentChunkName":"component---src-templates-post-template-tsx","path":"/reactdownload/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2>다운로드</h2>\n<p>ToyProject를 진행하는 중에 게시판 글에 다운로드 기능이 필요하여서</p>\n<p>게시판 글에 첨부파일을 다운로드하는 기능을 구현했습니다.</p>\n<p>아래에서 보여주는 소스는 ToyProject에 다운로드 기능과</p>\n<p>관련된 일부 코드 부분만을 추출하거나 수정해서 가져온겁니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//View.js</span>\r\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\r\n\r\n<span class=\"token function-variable function\">filedown</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>filename <span class=\"token operator\">===</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n    axios\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token string\">'/api/download?type='</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//data 자리</span>\r\n        <span class=\"token punctuation\">{</span>\r\n          <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token literal-property property\">responseType</span><span class=\"token operator\">:</span> <span class=\"token string\">'blob'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//이거중요함 (안하면 txt뺴고는 이미지,기타등등 다운로드 후 안읽어짐)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">//파일 데이터와 내용 유형을 인수로 전달하는 Blob 생성자사용</span>\r\n        <span class=\"token keyword\">const</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> response<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'content-type'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span> <span class=\"token comment\">//URL.createObject를 사용하여 Blob에서 URL 개체가 생성</span>\r\n        <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span>\r\n        link<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> url <span class=\"token comment\">//Blob의 콘텐츠에 액세스한 url를 link href에 넣어줌</span>\r\n        link<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'download'</span><span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">)</span> <span class=\"token comment\">//링크의 다운로드 특성이 원하는 파일 이름으로 설정</span>\r\n        link<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>cssText <span class=\"token operator\">=</span> <span class=\"token string\">'display:none'</span>\r\n        document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">)</span>\r\n        link<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        link<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        window<span class=\"token punctuation\">.</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">revokeObjectURL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 생성된 URL 개체는 URL.revokeObjectURL를 사용하여 해지(메모리 확보)</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'작업중 오류가 발생하였습니다.'</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>처음에 이미지 파일 다운로드 후 이미지가 안보여서 당황했었는데</p>\n<p>responseType: ‘blob’ 이걸 넣지 않아서 발생하는 문제였습니다.</p>\n<p>이거 때문에 애를 먹었던 기억이 납니다.</p>\n<p>아래는 서버쪽(node.js) 다운로드 전체 코드입니다.</p>\n<p>다운로드 관련 node.js 정보들은 금방 얻을 수 있고 이해할 수 있었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//DownloadRout.js</span>\r\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> express<span class=\"token punctuation\">.</span><span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> mime <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mime'</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">const</span> getDownloadFilename <span class=\"token operator\">=</span>\r\n  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./library/getDownloadFilename'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>getDownloadFilename <span class=\"token comment\">//한글도 다운받을수있게 처리</span>\r\n\r\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> upload_folder <span class=\"token operator\">=</span> <span class=\"token string\">'/ReactPratice/uploads/swmanual/'</span> <span class=\"token comment\">//서버용 '/home/ubuntu/reactpratice/uploads/swmanual/'</span>\r\n  <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> upload_folder <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>type <span class=\"token comment\">// ex) /upload/files/sample.txt</span>\r\n\r\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">existsSync</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 파일이 존재하는지 체크</span>\r\n      <span class=\"token keyword\">const</span> filename <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 파일 경로에서 파일명(확장자포함)만 추출</span>\r\n      <span class=\"token keyword\">const</span> mimetype <span class=\"token operator\">=</span> mime<span class=\"token punctuation\">.</span><span class=\"token function\">getType</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 파일의 타입(형식)을 가져옴</span>\r\n\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token string\">'Content-disposition'</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token string\">'attachment; filename='</span> <span class=\"token operator\">+</span> <span class=\"token function\">getDownloadFilename</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">)</span> <span class=\"token comment\">// 다운받아질 파일명 설정</span>\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-type'</span><span class=\"token punctuation\">,</span> mimetype<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 파일 형식 지정</span>\r\n\r\n      <span class=\"token keyword\">const</span> filestream <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">createReadStream</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\r\n      filestream<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'해당 파일이 없습니다.'</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">return</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 에러 발생시</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\r\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'파일을 다운로드하는 중에 에러가 발생하였습니다.'</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> router</code></pre></div>\n<h2><img src=\"/48c07e09c7a05d3248884d6b0a86ef99/download.png\" alt=\"file:///C:/Reactblog/LEEBLOG/static/react/download.PNG\"></h2>","frontmatter":{"title":"다운로드 기능 구현","summary":"다운로드 기능을 구현해보자","date":"2022.03.14.","categories":["React","ToyProject"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/ElEQVQoz2NQwgWUlZWUlZVVVEAMJWWsShhw6VVUkFeQk1WUk1WQk1VSUCBas7KyooKChrGZgU+IhrGZoW+ouoGxIki/MlGaFWSkDXyCTcIT3LrmmkYk6bn5yEtLgt2PXzPIWnlNcyvLtGLnxkk2+TVOjZMsUgo0TMxBlqPqx6ZZXs7QL8w0KsWpcZJjba9jbZ9pVIqBd7CinBwhzTAjzBOybfJqHKq6bQvqzKJTlRQViA0wBTlZHQdX45AYq8xS45A4LWt7BVkZIvwMjShFFXUNTVMLBWkpTTNLZTV1JUVFUuJZUVFBTlZZWUVRVharTnyaQbGqrAJNajgAAIe0an5q22AbAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/cba0b89d2bf2d96a1ed26edb5849f804/07887/reactthumbnail.png","srcSet":"/static/cba0b89d2bf2d96a1ed26edb5849f804/387ef/reactthumbnail.png 300w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/22925/reactthumbnail.png 600w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/07887/reactthumbnail.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/cba0b89d2bf2d96a1ed26edb5849f804/2fedb/reactthumbnail.webp 300w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/4fcbd/reactthumbnail.webp 600w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/0d4d1/reactthumbnail.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":630}},"publicURL":"/static/cba0b89d2bf2d96a1ed26edb5849f804/reactthumbnail.png"}}}}]}},"pageContext":{"slug":"/reactdownload/"}},"staticQueryHashes":[]}